---
title: "R Notebook"
output: github_document
---

# Necessary Libraries
```{r}
library(tidyverse)
library(viridis)
library(ggmap)
```

## Basic importating
```{r message=FALSE, warning=FALSE}
# Import data
df <- read_csv("/Users/tonnarcastellano/Desktop/R/Castellano_EDA20/eda20-team5-project/Data Cleaning/data.csv")
```

## Basic Exporlation
```{r}
is.data.frame(df)
dim(df)
head(df)
summary(df)
```

This data is about child opportunity index in United States. It has 146112 rows and 39 columns. The unit of analysis is town and each row shows a town's properties related to child education in 2010 and 2015. The shape of data is long and the class of data is dataframe.

# Data Cleaning

## Column names

Since there are so many observations in the data, we are going to focus on a specific state, Tennessee.

```{r message=FALSE, warning=FALSE}
# Separate the column "msaname15" into "city", "state", "size" and "no_mean"
df <- df %>% 
  separate(msaname15, c("city", "state", "size", "no_mean"), sep = " ")
```

According to the data dictionary, the unit of the 4 columns("ED_PRXECE", "ED_PRXHQECE", "HE_SUPRFND", "HE_RSEI") in the data is natural log. Natural log units change values less than e(2.71828) into negative numbers and this makes analysis difficult. Therefore, we are going to change the value of these 4 columns into original unit by using exp function.

```{r}
df<- df %>% 
  mutate(num_edu_center = exp(ED_PRXECE)) %>%
  mutate(num_good_edu_center = exp(ED_PRXHQECE)) %>%
  mutate(num_waste_dump_site = exp(HE_SUPRFND)) %>%
  mutate(population = exp(HE_RSEI)) %>%
  select(-ED_PRXECE, -ED_PRXHQECE, -HE_SUPRFND, -HE_RSEI)
```

Most of the columns are hard to understand. We tried to make it easier and obvious even without the data dictionary.

```{r}
df <- df %>% 
  rename(id = `_id`) %>% 
  rename(geo_id = geoid) %>% 
  rename(metro_areas = in100) %>%
  rename(area_code = msaid15) %>% 
  rename(county_code = countyfips) %>%
  rename(num_under_18 = pop) %>% 
  rename(AP_students = ED_APENR) %>%
  rename(college_deg = ED_ATTAIN) %>%
  rename(num_college_enrolled = ED_COLLEGE) %>%
  rename(preschoolers = ED_ECENROL) %>%
  rename(hs_grads = ED_HSGRAD) %>%
  rename(third_g_math = ED_MATH) %>%
  rename(third_g_read = ED_READING) %>%
  rename(elementary_school_poverty = ED_SCHPOV) %>% 
  rename(firstsecond_y_teachers =ED_TEACHXP) %>% 
  rename(supermarket_nearby = HE_FOOD) %>% 
  rename(green_spaces = HE_GREEN) %>%
  rename(days_temp_above90 = HE_HEAT) %>%
  rename(phealth_insurance = HE_HLTHINS) %>%
  rename(mean_ozone_amount = HE_OZONE) %>%
  rename(mean_microparticle = HE_PM25) %>%
  rename(housing_vacancy = HE_VACANCY) %>%
  rename(walkability = HE_WALK) %>% 
  rename(below100_poverty = SE_POVRATE) %>%
  rename(public_assistance = SE_PUBLIC) %>%
  rename(home_ownership = SE_HOME) %>%
  rename(perc_over15_high_skill = SE_OCC) %>%
  rename(median_income=SE_MHE) %>%
  rename(employment_rate = SE_EMPRAT) %>%
  rename(commute_over1hour = SE_JOBPROX) %>%
  rename(single_parents = SE_SINGLE)
```

Deleted unnecessary columns (They have the same values.)

```{r}
df <- df %>% select(-state, -no_mean, -statefips, -num_waste_dump_site)
```

This is the final data after cleaning columns and values.

```{r}
head(df)
```

## Dealing with NA values.

Creates a new dataframe that gives us a count of the na's in each variable column.

```{r message=FALSE, warning=FALSE}
extra_NA<- df %>% 
  select_if(function(x) any(is.na(x))) %>% 
  summarise_each(funs(sum(is.na(.))))

extra_NA
```

In order to decide how to deal with NA values, we made a subset which has the rows containing NA values to see their properties.

```{r}
NA_subset <- df[rowSums(is.na(df)) > 0, ]
NA_subset
```

Some rows have more NAs than meaningful values. For these rows, due to the potential of providing misleading results for analysis, they were deleted from the dataset. 

```{r}
# Delete some rows having more NAs than meaningful values.
df <- df %>% filter((geo_id != 47155980100) & (geo_id != 47145980100) & (geo_id != 47031980100) & (geo_id != 47029980100) & (geo_id != 47009980200) & (geo_id != 47009980100) & (geo_id != 47001980100) & (geo_id != 47037980100) & (geo_id != 47037980200) & (geo_id != 47037013000))
```


Now, our data is ready to be analyzed!
We will have to decide how to to handle NA's

## Introduction to NYC
```{r}
register_google('AIzaSyDgQO0YgKUUTF9Og7YLzSGBEjcRUWkTajI')

mapnyc <- data.frame(latitude = c(35.7032815,38.7082398),
                     longitude = c(-74.0192166, -74.0054436),
                     logprice = c(120,56))
nyc_base <- ggmap::get_map("New York City", zoom = 11)
ggmap(nyc_base)
```


For the other cities we choose to the surrounding areas as it can be
hard to break up the city itself into very distinct areas. However, New
York city is a bit odd in this respect because it so easily is broken up
into the five borrows. These five boroughs have unique characteristics
that are represented similarly as suburban and other surrounding areas
would be for other major metropolitan areas. As such, we decided to opt
for looking at the education and economic opportunities exclusively
within New York City. We believe that this better represents our
motivating question because it would allow us to slice the data across
distinct axis while still retaining the heart of where is the most
opportunity.

## Life in The City
Life quality is in a city is an exceptionally hard thing to measure and will tend to vary from person to person. While quality of life might seem like an extraneous variable it is intimately linked to success even if it is not always in an obvious manner. Unfortunately, our study is focused more on the educational and economic indicators of success in a city. However, the data as mentioned is still exceptionally important so while not the main focus on the analysis it is still worth including if for no other reason than to paint a picture of the overall understanding of the boroughs in the city. 

```{r}
df_nyc <- df %>% filter(
    county_code == '36061' |
    county_code ==  '36047' |
    county_code ==  '36081' |
    county_code ==  '36005' |
    county_code ==  '36085' 
)

df_nyc <- df_nyc %>%
  mutate(county_code = replace(county_code, county_code == '36061', 'Manhattan')) %>% 
  mutate(county_code = replace(county_code, county_code == '36047', 'Brooklyn')) %>%
  mutate(county_code =  replace(county_code, county_code == '36081', 'Queens')) %>%
  mutate(county_code =  replace(county_code, county_code == '36005', 'Bronx')) %>%
  mutate(county_code =  replace(county_code, county_code == '36085', 'Staten Island'))%>%
  mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))

df_nyc_life <-df_nyc %>% select(supermarket_nearby,green_spaces,commute_over1hour,walkability,housing_vacancy,num_good_edu_center,mean_microparticle,below100_poverty,median_income,county_code) %>%  mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))
```

### Commutes and Walkability
```{r}
df_nyc_life %>% ggplot(aes(y = walkability, x = commute_over1hour))+
                         geom_point()+ 
  facet_grid(.~ county_code)
```

The first part of the analysis will link the walkability. As a general rule of thumb big cities tend to be more "walkable". As such, it seems there should be a direct negative relationship between the commute_over1hour and the walkability of the city. It seems however that most of the boroughs in the city tend to be equally walkable and have similar percentages of commutes over an hour. 

### Green Spaces and Pollution 
```{r}
df_nyc_life %>% ggplot(aes(y = green_spaces, x = mean_microparticle))+
                         geom_point()+ 
  facet_grid(.~ county_code)
```

It does seem that there also a lack of relationship between the number of green spaces and the mean micro-particles i.e. pollution. The amount of pollution does seem to be fairly high in all of them expect Staten Island which consequently appears to exhibit the least amount of green spaces. However, it is worth mentioning that might be skewed for Manhattan due to Central Park. 


### Neighborhood Population and Poverty 
```{r}
df_nyc_life %>% filter(housing_vacancy <= 50) %>% ggplot(aes(y = housing_vacancy, x = below100_poverty))+
                         geom_point()+ 
  facet_grid(.~ county_code)
```

The last factor worth examining in city life is the number of impoverished people and the amount of housing vacancy. Here we do see a bit more of a relationship with less poverty as a general role of them leading to less vacancy. This should not be a surprising trend. We do seem to see not as stark of a relationship as might be viewed in cities with more space for houses than New York. 


### Education Centers
```{r}
df_nyc_life %>% ggplot(aes(y = num_good_edu_center, x = median_income))+
                         geom_point()+ 
  facet_grid(.~ county_code)
```

The last factor is a perfect sequeway to the topic of education. This graph is fairly inline also with what we would expect to see which is that as the income increases in the borough better education centers appear. 

## Childhood Education Status

### Math and Reading in Elementary School Students
```{r}
df_nyc <- df %>% filter(
    county_code == '36061' |
    county_code ==  '36047' |
    county_code ==  '36081' |
    county_code ==  '36005' |
    county_code ==  '36085' 
) %>%
  select(
    population,
    county_code,
    year,
    city,
    AP_students,
    num_college_enrolled,
    preschoolers,
    hs_grads,
    third_g_math,
    third_g_read,
    elementary_school_poverty,
    firstsecond_y_teachers,
    median_income,
    employment_rate
  )



df_nyc <- df_nyc %>%
  mutate(county_code = replace(county_code, county_code == '36061', 'Manhattan')) %>% 
  mutate(county_code = replace(county_code, county_code == '36047', 'Brooklyn')) %>%
  mutate(county_code =  replace(county_code, county_code == '36081', 'Queens')) %>%
  mutate(county_code =  replace(county_code, county_code == '36005', 'Bronx')) %>%
  mutate(county_code =  replace(county_code, county_code == '36085', 'Staten Island'))%>%
  mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x)) 


df_nyc_2010 <-
  df_nyc %>% filter(year == 2010)

df_nyc_2015 <-
  df_nyc %>% filter(year == 2015)
```


```{r warning=FALSE}
df_nyc_2010 %>% group_by(county_code) %>% 
  ggplot(aes(x =  third_g_read, y =  third_g_math))+
  geom_point(aes(color = county_code),alpha = .5)+
  scale_y_continuous(limits = c(0,450))+
  scale_x_continuous(limits = c(0,450))+
  labs(
    title = 'Elementary School Education in New York City 2010',
    subtitle = 'Data from DataDiversityKids.org',
    y = 'Kids above a 3rd Grade Math Level',
    x = 'Kids above a 3rd Grade Reading Level',
    color = 'NYC Borough'
  )+
  
  theme_classic()

  
df_nyc_2015 %>% group_by(county_code) %>% 
  ggplot(aes(x =  third_g_read, y =  third_g_math, color = county_code))+
  geom_point( alpha = .5)+
  scale_y_continuous(limits = c(0,450))+
  scale_x_continuous(limits = c(0,450))+
  labs(
    title = 'Elementary School Education in New York City 2015',
    subtitle = 'Data from DataDiversityKids.org',
    y = 'Kids Above a 3rd Grade Math Level by School',
    x = 'Kids Above a 3rd Grade Reading Level by School',
    color = 'NYC Borough'
  )+
  theme_classic()
```

The first and most obvious indicator of education success is how well elementary students are doing in a given area. This obviously hinges on numerous factors such as teachers and income just for starters. However, first we will want to look at the trends and correlation between the two factors and across the two years given in our data set. 

As expected, reading and math scores at the third grade level track in nearly lockstep across all boroughs. This makes sense because most of the students have not specialized like they will in college and the material at this level more tests cognitive ability than skills within that field(find citation). However, what is interesting is the dispersion of the data of exhibits a higher variance over time. Due to the amount of points it can be hard to see who did better, worse, or stayed the same.

```{r}
df_nyc %>% group_by(year,county_code) %>% summarise(values = mean(third_g_math)) %>%
  mutate(year = as.character(year)) %>%
  ggplot(aes(x = year, y = values))+
  geom_point(aes(color = county_code), size = 5)+
  geom_line(aes(color = county_code, group = county_code), linetype = "dashed")+
  scale_x_discrete(expand = c(.2,.2))+
  scale_y_continuous(limits = c(0,300))+
  labs(
    title = 'Elementary School Education in New York City 2010',
    subtitle = 'Data from DataDiversityKids.org',
    y = 'Kids Above a 3rd Grade Math Level ',
    x = 'Year',
    color = 'NYC Borough'
  )+
  theme_classic()

df_nyc %>% group_by(year,county_code) %>% summarise(values = mean(third_g_read)) %>%
  mutate(year = as.character(year)) %>%
  ggplot(aes(x = year, y = values))+
  geom_point(aes(color = county_code), size = 5)+
  geom_line(aes(color = county_code, group = county_code), linetype = "dashed")+
  scale_x_discrete(expand = c(.2,.2))+
  scale_y_continuous(limits = c(0,300))+
  labs(
    title = 'Elementary School Education in New York City 2010',
    subtitle = 'Data from DataDiversityKids.org',
    y = 'Kids Above a 3rd Grade Reading Level',
    x = 'Year',
    color = 'NYC Borough'
  )+
  theme_classic()
```

Given our code above the next logical step is to break out the boroughs into more easily identifiable parts while stilling maintaining a comparison between them. The comparison is broken up by reading and math scores independently because those made up  the axis from the above graph. Two major facets quickly become apparent in the data. The first is that math scores trended down over time. The other major structure within the data is how the five boroughs faired. Manhattan was clearly the best and the Bronx was clearly the worst from this analysis. 

Moving forward we will compare Manhattan and the Bronx because of the stark differences it should be easier to find potentially patterns that *could* cause or represent these differences.

```{r}
df_poverty_manhattan  <- df_nyc %>% filter(county_code == 'Manhattan')%>% select(elementary_school_poverty)
df_poverty_bronx <- df_nyc %>% filter(county_code == 'Bronx') %>% select(elementary_school_poverty)

ggplot()+
  geom_histogram(data = df_poverty_manhattan, aes(x = elementary_school_poverty, y = ..density..), fill = 'purple', color = 'black', alpha = .3,bins = 20)+
   geom_histogram(data = df_poverty_bronx, aes(x = elementary_school_poverty,  y = ..density..), fill = 'yellow', color = 'black', alpha = .5, bins = 20)+
  scale_color_manual(values = fill)+
  theme_linedraw()+
    labs(
    title = 'Elementary School Education in New York City 2010',
    subtitle = 'Data from DataDiversityKids.org',
    x = 'Elementary School Poverty'
  )
```

The first and most obvious one to check is the levels of poverty exhibited by the school. If Manhattan and the Bronx exhibit different levels of poverty especially significant ones it could be a leading cause in what causes the differences in math and reading ability. The graph above which plots the frequency of which schools are afflicted with poverty paints a clear picture that Manhattan has both less severe poverty and less frequent poverty. However, it is possible that this maybe has no affect on ability. 
```{r}
df_nyc %>% filter(county_code == 'Manhattan' | county_code == 'Bronx') %>% select(elementary_school_poverty,county_code,third_g_math,third_g_read) %>% 
  ggplot(aes(x = county_code, y = third_g_read))+
  geom_violin()+
  geom_jitter(aes(color = elementary_school_poverty), width = .3, alpha = .5)+
  scale_color_viridis()+
  theme_classic()

df_nyc %>% filter(county_code == 'Manhattan' | county_code == 'Bronx') %>% select(elementary_school_poverty,county_code,third_g_math,third_g_read) %>% 
  ggplot(aes(x = county_code, y = third_g_math))+
  geom_violin()+
  geom_jitter(aes(color = elementary_school_poverty), width = .3, alpha = .5)+
  scale_color_viridis()+
  theme_classic()
```

This final graph for this section helps us to confirm the **correlation** between math and reading ability. It seems like there is a direct connection between the amount of poverty and the ability of the students. However, further testing would need to be done to establish causation. One thing worth noting is that it seems that being more impoverished causes worse reading but being wealthy causes better math. Said another way math seems to do better if you are rich and reading seems to do worse if you are poor. 

## Economic Variablity in the City
```{r}
df_nyc <- df %>% filter(
    county_code == '36061' |
    county_code ==  '36047' |
    county_code ==  '36081' |
    county_code ==  '36005' |
    county_code ==  '36085' 
)

df_nyc <- df_nyc %>%
  mutate(county_code = replace(county_code, county_code == '36061', 'Manhattan')) %>% 
  mutate(county_code = replace(county_code, county_code == '36047', 'Brooklyn')) %>%
  mutate(county_code =  replace(county_code, county_code == '36081', 'Queens')) %>%
  mutate(county_code =  replace(county_code, county_code == '36005', 'Bronx')) %>%
  mutate(county_code =  replace(county_code, county_code == '36085', 'Staten Island'))%>%
  mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))
```

```{r}
df_adult_success <- df_nyc %>% select(county_code,college_deg,median_income,phealth_insurance,perc_over15_high_skill,home_ownership,employment_rate)
```

### Median Income
```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = county_code, y = median_income))+
  geom_violin() + 
  geom_jitter(aes(y = median_income), alpha = .2)
```

The first economic indicator of economic success seems pretty obvious - the amount of money made in terms of the median. The mean is avoided here to prevent extreme cases from driving up or down the amount. From the graph the first two that stick out are Manhattan and the Bronx for the opposite reasons. Manhattan seems to have more economic success and the Bronx seems to be struggling. As the financial center of the world it does not come as a surprise to Manhattans success. However, given the proximity of the Bronx to Manhattan the reason for the Bronx's struggle is not as clear.

```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = college_deg, y = median_income))+
  geom_point(aes(color = county_code), alpha = .5)+
  scale_y_continuous(limits = c(0,150000))
```

The first factor that one could guess that would potentially drive economic success is college degrees(add citation). As such, it does not come as a surprise that there appears to be a nearly one to one relationship between the two. However, what is interesting is that on the first graph Staten Island seemed to come in second in terms of median income but appears to have less college degrees as a percentage than Brooklyn(look more into this). Unsurprisingly Manhattan seems to have the most college degrees and highest financial success.

```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = county_code, y = employment_rate))+
  geom_violin() + 
  geom_jitter(aes(y = employment_rate), alpha = .2)
```

What is interesting to note here is that there does not seem to be much in the way of difference in terms of the employment rate. However, this graph can be a bit misleading as everything seems to be high. 75% unemployment is a very large portion of the population. To put this into perspective, unemployment in the United States is generally around 90%. Staten Island seems like the outliers here exhibiting a high income  but a lower rate of college degrees and employment (examine more).



```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = college_deg, y = employment_rate))+
  geom_point(aes(color = county_code), alpha = .5)
```
This is one of the most interesting graphs. It appears from this graph that the employment rate is nearly devoid of a relationship with a college degree expect in the extreme cases of a lack of degree. However, it is very possible that relationship is actually inverted with the employment generating whether someone has the opportunity to go to college instead of the other way around.  

 

```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = perc_over15_high_skill, y = employment_rate))+
  geom_point(aes(color = county_code), alpha = .5)
```
Given the relationship above it seems to make sense that perhaps is being a high skilled worked that drives employment rate. However, that also does not seem to be true expect again in the extreme case. 
```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = perc_over15_high_skill, y = median_income))+
  geom_point(aes(color = county_code), alpha = .5)
```
However, college degrees are not the sole measure for financial stability. There are numerous other factors like being high skilled worker which would include things like trade school. Here you do see a bit more of a relationship between high skill and median income though not one as stark as having a college degree. 

```{r}
df_adult_success %>% group_by(county_code) %>% ggplot(aes(x = county_code, y = home_ownership))+
  geom_violin() + 
  geom_jitter(aes(y = home_ownership, color = median_income), alpha = .5)+
  scale_color_viridis()
```
The last graph might seem like it belongs in livability which is an argument is  fairly solid. However, given that often times a house seems to be the largest asset housing rates are also right at home in financial success. While one might expect Manhattan to have the largest amount of homes it is apparent this is not the case until you progress into the super wealthy. Given the price of real estate in the city this makes sense. The Bronx also matchs what you would expect as does Staten Island as real estate prices drop. 
